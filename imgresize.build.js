/*
 * imgResize.js
 *
 * Copyright 2013, Simon Waldherr - http://simon.waldherr.eu/
 * Released under the MIT Licence
 * http://opensource.org/licenses/MIT
 *
 * Github:  https://github.com/SimonWaldherr/imgResize.js
 * Version: 0.1.1
 */
 
/*jslint browser: true, plusplus: true, bitwise: true, indent: 2*/
/*global Image,ArrayBuffer,Uint8ClampedArray,Uint32Array*/
/*exported imgSmartResize*/
function edgeDetection(a,b,c,d,e){"use strict";var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=d.createImageData(e.width,e.height),E=a.width,F=a.height,G=a.data,H=D.data,I=4*E,J=I+4,K=F-1,L=E-1;for(C=1;K>C;C+=1){for(f=J-4,g=f-I,h=f+I,j=-G[g]-G[f]-G[h],k=-G[g+=1]-G[f+=1]-G[h+=1],l=-G[g+=1]-G[f+=1]-G[h+=1],m=G[g+=2],n=G[f+=2],o=G[h+=2],p=-m-n-o,q=G[g+=1],r=G[f+=1],s=G[h+=1],t=-q-r-s,u=G[g+=1],v=G[f+=1],w=G[h+=1],x=-u-v-w,B=1;L>B;B+=1)f=J+4,g=f-I,h=f+I,y=b+j-m- -8*n-o,z=b+k-q- -8*r-s,A=b+l-u- -8*v-w,j=p,k=t,l=x,m=G[g],n=G[f],o=G[h],p=-m-n-o,q=G[g+=1],r=G[f+=1],s=G[h+=1],t=-q-r-s,u=G[g+=1],v=G[f+=1],w=G[h+=1],x=-u-v-w,c?(i=.3*(y+p)+.59*(z+t)+.11*(A+x),H[J]=i,H[J+=1]=i,H[J+=1]=i):(H[J]=y+p,H[J+=1]=z+t,H[J+=1]=A+x),H[J+=1]=255,J+=1;J+=8}return D}function doColorBook(a,b,c,d){"use strict";var e,f,g,h,i=a.width,j=a.height,k=edgeDetection(a,255,1,b,c),l=k.data,m=[],n=!1,o=!1,p=0;for(f=0;j>f;f+=1)for("m"===d&&(m[f]=[]),g=0;i>g;g+=1)"m"===d?m[f][g]=l[p]:"h"===d?e=m[f]:"w"===d&&(e=m[g]),"m"!==d&&(l[p]<240?(void 0===e&&("h"===d?m[f]=0:"w"===d&&(m[g]=0),e=0),"h"===d?m[f]+=1:"w"===d&&(m[g]+=1),e+=1):void 0===e&&("h"===d?m[f]=0:"w"===d&&(m[g]=0),e=0),(o>e||!o)&&(o=e),(e>n||!n)&&(n=e)),p+=4;if("m"===d)return m;for(h=0;h<m.length;h+=1)m[h]=parseInt(255*((m[h]-o)/(n-o)),10);return m}function imgSmartResize(a){"use strict";function b(a,b){var c;for(c=0;c<b.length;++c)if(b[c]===a)return!0;return!1}function c(a){var b="string"!=typeof a.ocanvas?a.ocanvas:document.getElementById(a.ocanvas),c=b.getContext("2d"),d=c.getImageData(0,0,b.width,b.height),e=[];return 1===a.mode?(e[0]=doColorBook(d,c,b,"w"),e[1]=doColorBook(d,c,b,"h")):2===a.mode&&(e[2]=doColorBook(d,c,b,"m")),e}function d(a){return a.indexOf(Math.min(a))}function e(a,b){var c,d,e=[],f=[];for(e=a.slice(),b=void 0===b?e.length:b>e.length?e.length:b,d=0;b>d;d+=1)c=e.indexOf(Math.min.apply(window,e)),e[c]<255&&(e[c]=255,f[f.length]=c);return f}var f,g,h,i,j,k,l,m,n,o,p="string"!=typeof a.canvas?a.canvas:document.getElementById(a.canvas),q="string"!=typeof a.ocanvas?a.ocanvas:document.getElementById(a.ocanvas),r=void 0!==a.img?"string"!=typeof a.img?a.img.src:a.img:p.getAttribute("data-src"),s=void 0!==a.height?a.height:p.getAttribute("height"),t=void 0!==a.width?a.width:p.getAttribute("width"),u=p.getContext("2d"),v=q.getContext("2d"),w=v.getImageData(0,0,q.getAttribute("width"),q.getAttribute("height")),x=u.createImageData(t,s),y=q.getAttribute("height"),z=q.getAttribute("width"),A=w.data,B=new ArrayBuffer(4*t*s),C=new Uint8ClampedArray(B),D=new Uint32Array(B),E=[],F=0,G=0,H=[];void 0===edgeDetectLines?edgeDetectLines=c(a):0===edgeDetectLines.length&&(edgeDetectLines=c(a)),s=parseInt(s,10),t=parseInt(t,10);var I,J=0;if(1===a.mode)g=e(edgeDetectLines[1],q.getAttribute("height")-s),h=e(edgeDetectLines[0],q.getAttribute("width")-t);else{for(o=0;o<edgeDetectLines[2].length;o++)E[o]=edgeDetectLines[2][o].slice();for(k=0;y>k;++k)for(H[k]={},I=E[k].sort(),j=0;t>j;j++)if(f=d(E[k]),-1!==f)H[k][f]=!0,E[k][f]=0;else{for(J=random(0,t);H[k][J]===!0;)J=random(0,t);H[k][J]=!0,E[k][J]=0}}if(console.log(H),p.width=t,p.height=s,1===a.mode)for(k=0;y>k;++k)if(b(k,g)!==!0)for(j=0;z>j;++j)b(j,h)!==!0&&(l=A[4*F],m=A[4*F+1],n=A[4*F+2],D[G]=255<<24|n<<16|m<<8|l,++G),++F;else F+=j;else if(2===a.mode)for(k=0;y>k;++k)for(j=0;z>j;++j)H[k][j]===!0&&(l=A[4*F],m=A[4*F+1],n=A[4*F+2],D[G]=255<<24|n<<16|m<<8|l,++G),++F;x.data.set(C),i=new Image,i.src=r,u.putImageData(x,0,0,0,0,t,s)}var edgeDetectLines=[];